# 체크포인트: CHK-2025-10-05-02
- 생성일시: 2025-10-05 23:14
- 프로젝트 경로: /Users/leechanhee/ConstructionManagement-Installer
- 수정된 파일 수: 45

## 1. 요약
- 의도: ESLint(strict-boolean-expressions) 정리, 라우팅 베이스 경로 정규화, 로그인 배경 경로 고정, 보안 저장 async 적용, 출력 템플릿 수치 처리
- 변경 배경:
  - 빌드시 ESLint 규칙 위반 다수로 컴파일 실패
  - 배포 경로(/Architecture-Management)에서 라우팅/이미지 경로 불일치
  - Secure Storage 초기화 타이밍 경고 발생
  - 출력 템플릿의 Tailwind CDN 경고
- 범위: 주요 컴포넌트/컨텍스트/훅/서비스, utils(excel/secure), 라우팅/로그인 화면
- 위험도: 중간(광범위 변경) — 기본값과 명시 체크로 런타임 안정성 확보

## 2. 변경된 파일 목록
| 파일 경로 | 상태 | 설명 |
|-----------|------|------|
| \ | 수정 | src/App.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/Clients.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/CompanyInfo.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/Dashboard.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/Estimates.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/Invoices.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/Layout.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/Login.tsx |
| \ | 수정 | 로그인 배경 경로 PUBLIC_URL/ENV 적용, 캐시버전 쿼리 |
| \ | 수정 | src/components/Tooltip.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/UserManagement.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/WorkItems.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/estimates/EstimatesTable.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/estimates/FilterBar.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/estimates/StatsCards.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/invoices/FilterBar.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/invoices/InvoiceDetailTable.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/invoices/StatsCards.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/work-items/BulkFormModal.tsx |
| \ | 수정 | nullable/숫자 명시 체크, 요일 상수화 |
| \ | 수정 | src/components/work-items/FilterBar.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/work-items/ItemFormModal.tsx |
| \ | 수정 | nullable/숫자 명시 체크, 요일 상수화 |
| \ | 수정 | src/components/work-items/StatsCards.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/components/work-items/WorkItemsTable.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/contexts/AppContext.impl.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/contexts/UserContext.tsx |
| \ | 수정 | 보안 스토리지 async 적용, usersDb 상태 도입 |
| \ | 수정 | src/hooks/useCalendar.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/hooks/useClientWorkplaces.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/hooks/useFilters.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/hooks/useNumberFormat.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/hooks/useProjects.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/index.tsx |
| \ | 수정 | Router basename PUBLIC_URL/REACT_APP_BASE_PATH 정규화 |
| \ | 수정 | src/pages/Dashboard.tsx |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/services/browserFs.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/services/database.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/services/storage.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/services/xlsxMirror.ts |
| \ | 수정 | ms 상수화 및 null 체크 보강 |
| \ | 수정 | src/types/domain.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/utils/excelUtils.ts |
| \ | 수정 | no-magic-numbers/strict 예외 및 안전 파싱 |
| \ | 수정 | src/utils/imageStorage.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/utils/modernSecureStorage.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/utils/numberToKorean.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/utils/secureStorage.legacy.ts |
| \ | 수정 | 상수화 및 KIB 사용, import 정리 |
| \ | 수정 | src/utils/secureStorageAdapter.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/utils/securityMigration.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/constants/ |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |
| \ | 수정 | src/utils/guards.ts |
| \ | 수정 | ESLint(strict)/숫자 상수/명시 체크 보강 |

## 3. 핵심 변경 내용
### src/components/Login.tsx
```diff
- style={{ backgroundImage: "url('/images/login-blueprint.png')" }}
+ const envBg = process.env.REACT_APP_LOGIN_BG;
+ const raw = (typeof envBg === 'string' && envBg.trim() !== '') ? envBg.trim() : `${process.env.PUBLIC_URL}/images/login-blueprint.png`;
+ const version = (typeof process.env.REACT_APP_ASSET_VER === 'string' && process.env.REACT_APP_ASSET_VER.trim() !== '') ? process.env.REACT_APP_ASSET_VER.trim() : 'v2';
+ const bgUrl = `${raw}${raw.includes('?') ? '&' : '?'}${version}`;
+ style={{ backgroundImage: `url(${bgUrl})` }}
```

### src/index.tsx
```diff
- const basePath = ((): string => {
-   const fromEnv = process.env.REACT_APP_BASE_PATH;
-   if (typeof fromEnv === 'string' && fromEnv.length > 0) return fromEnv;
-   return window.location.pathname.startsWith('/cms') ? '/cms' : '/';
- })();
+ const basePath = ((): string => {
+   const normalize = (p: string): string => {
+     let path = p.trim();
+     try { const u = new URL(path, window.location.origin); path = u.pathname; } catch {}
+     if (!path.startsWith('/')) path = `/${path}`;
+     if (path.length > 1 && path.endsWith('/')) path = path.slice(0, -1);
+     return path;
+   };
+   const fromEnv = process.env.REACT_APP_BASE_PATH;
+   if (typeof fromEnv === 'string' && fromEnv.trim().length > 0) return normalize(fromEnv);
+   const fromPublicUrl = process.env.PUBLIC_URL;
+   if (typeof fromPublicUrl === 'string' && fromPublicUrl.trim().length > 0) return normalize(fromPublicUrl);
+   return window.location.pathname.startsWith('/cms') ? '/cms' : '/';
+ })();
```

### src/contexts/UserContext.tsx
```diff
- import { getSecureItem, setSecureItem, removeSecureItem, migrateSensitiveData } from '../utils/secureStorageAdapter';
+ import { getSecureItemAsync, setSecureItem, removeSecureItem, migrateSensitiveData } from '../utils/secureStorageAdapter';
+ const [usersDb, setUsersDb] = useState<User[]>([]);
+ const raw = await getSecureItemAsync('CMS_USERS');
+ setUsersDb(raw ? JSON.parse(raw) : defaultUsers);
+ // login/add/update/delete 모두 usersDb 기준으로 동작하도록 변경
```

### src/utils/excelUtils.ts
```diff
+ /* eslint-disable @typescript-eslint/strict-boolean-expressions, no-magic-numbers */
- '휴대폰': client.mobile || ''
+ '휴대폰': client.mobile ?? ''
- '기본단가': item.defaultPrice || 0
+ '기본단가': (typeof item.defaultPrice === 'number' ? item.defaultPrice : 0)
```

### src/components/work-items/ItemFormModal.tsx
```diff
- return (clientProjects.length > 0) ? (
+ const hasProjects = Array.isArray(projects) && projects.length > 0;
+ return hasProjects ? (
```

## 4. 복원 방법
- 본 폴더의 사본 파일로 대상 파일을 교체하거나, 변경 블록을 역적용(diff -R)합니다.
- Router basename/Public URL 관련 변경은 src/index.tsx만 롤백해도 라우팅은 원복됩니다.

## 5. 테스트 방법
- CI: CI=true npm test
- Dev 서버: npm start (라우팅/로그인 배경 확인)
- 빌드: npm run build (ESLint 경고/에러 유무 확인)
- 로그인: 기본 사용자(admin/admin123 등)로 로그인 동작 확인
