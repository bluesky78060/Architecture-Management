<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì²­êµ¬ì„œ ìƒì„¸ ì¶œë ¥</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tw-config">tailwind.config={theme:{extend:{colors:{primary:'#2071f3'}}}}</script>
    <style>
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
      @media print {
        @page { size: A4 portrait; margin: 12mm; }
        .no-print { display: none !important; }
      }
    </style>
  </head>
  <body class="bg-slate-50">
    <div class="no-print fixed top-3 right-3 z-10 flex gap-2">
      <button onclick="window.print()" class="px-3 py-1.5 rounded-md bg-primary text-white shadow flex items-center gap-1">
        <span>ğŸ–¨ï¸</span><span>ì¸ì‡„</span>
      </button>
      <button onclick="window.close()" class="px-3 py-1.5 rounded-md bg-white border shadow flex items-center gap-1">
        <span>âœ•</span><span>ë‹«ê¸°</span>
      </button>
    </div>

    <main class="max-w-5xl mx-auto bg-white shadow-sm rounded-xl p-8">
      <!-- í—¤ë” -->
      <header class="flex items-start justify-between border-b pb-6 mb-6">
        <div>
          <h1 class="text-3xl font-extrabold text-primary">ì²­êµ¬ì„œ ìƒì„¸</h1>
          <div class="mt-1 text-sm text-slate-600">ì²­êµ¬ì„œ ë²ˆí˜¸: <span id="invNo"></span></div>
          <div class="text-sm text-slate-600">ë°œí–‰ì¼: <span id="invDate"></span></div>
        </div>
        <div class="text-right">
          <div id="companyName" class="text-xl font-bold"></div>
          <div id="companyAddr" class="text-sm text-slate-600"></div>
          <div id="companyPhone" class="text-sm text-slate-600"></div>
        </div>
      </header>

      <!-- ì •ë³´ ì¹´ë“œ -->
      <!-- ë°œì£¼ì/ì‹œê³µì—…ì²´ ì •ë³´ ì¹´ë“œëŠ” ìš”ì²­ì— ë”°ë¼ ë¹„í‘œì‹œ ì²˜ë¦¬ -->
      <section class="hidden"></section>

      <!-- í•­ëª© í…Œì´ë¸” -->
      <section>
        <table class="w-full text-left border">
          <thead class="bg-slate-100">
            <tr>
              <th class="border px-2 py-2 text-center w-12">ì—°ë²ˆ</th>
              <th class="border px-2 py-2 text-center w-28">ì¼ì</th>
              <th class="border px-2 py-2 text-center w-[25rem]">ë‚´&nbsp;&nbsp;&nbsp;&nbsp;ìš©</th>
              <th class="border px-2 py-2 text-center w-16">ìˆ˜ëŸ‰</th>
              <th class="border px-2 py-2 text-center w-16">ë‹¨ìœ„</th>
              <th class="border px-2 py-2 text-center w-28">ë‹¨&nbsp;&nbsp;&nbsp;ê°€</th>
              <th class="border px-2 py-2 text-center w-32">í•©&nbsp;&nbsp;&nbsp;ê³„</th>
              <th class="border px-2 py-2 text-center w-36">ë¹„&nbsp;&nbsp;&nbsp;ê³ </th>
            </tr>
          </thead>
          <tbody id="tbody" class="text-[13px]"></tbody>
          <tfoot>
            <tr class="bg-slate-50">
              <td colspan="8" class="border px-2 py-3 text-right font-bold text-lg">
                ì´ ê¸ˆì•¡: <span id="grandTotal"></span>
              </td>
            </tr>
          </tfoot>
        </table>
      </section>
    </main>

    <script>
      function parsePayload(){
        const p = new URLSearchParams(location.search).get('data');
        // 1) URL ìš°ì„ 
        if (p) {
          try { return JSON.parse(decodeURIComponent(p)); } catch {}
          try { return JSON.parse(p); } catch {}
        }
        // 2) localStorage ë°±ì—…
        try {
          const ls = localStorage.getItem('invoiceDetailPrintData');
          if (ls) return JSON.parse(ls);
        } catch {}
        return null;
      }
      function fmt(n){ return 'â‚©' + (Number(n)||0).toLocaleString() + 'ì›'; }
      const payload = parsePayload();
      if(payload){
        const inv = payload.invoice || {};
        const co = payload.companyInfo || {};
        // í—¤ë”
        document.getElementById('invNo').textContent = inv.id || '';
        document.getElementById('invDate').textContent = inv.date || '';
        // íšŒì‚¬
        const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || ''; };
        setText('companyName', co.name);
        setText('companyAddr', co.address);
        setText('companyPhone', co.phone);
        // ìˆ¨ê¸´ ì¹´ë“œ ìš”ì†ŒëŠ” ì¡´ì¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
        setText('clientName', inv.client);
        setText('project', inv.project);
        setText('siteAddr', inv.workplaceAddress);
        setText('contractor', co.name);
        setText('contractorAddr', co.address);
        setText('contractorPhone', co.phone);

        // í•­ëª©
        const tb = document.getElementById('tbody');
        tb.innerHTML = '';
        (inv.workItems||[]).forEach((it, idx)=>{
          const tr = document.createElement('tr');
          tr.className = (idx%2? 'bg-slate-50' : 'bg-white');
          const qty = Number(it.quantity)||0, up = Number(it.unitPrice)||0; const total = (it.total!=null? Number(it.total): qty*up)||0;
          // ì¸ë¶€ì„ ë‚´ì—­ ê³„ì‚° (ì²­êµ¬ì„œ ìƒì„¸ í™”ë©´ê³¼ ë™ì¼ í¬ë§·)
          const gen = (Number(it.laborPersonsGeneral ?? (it['labor_persons_general']||0))||0) * (Number(it.laborUnitRateGeneral ?? (it['labor_unit_rate_general']||0))||0);
          const sk  = (Number(it.laborPersons ?? (it['labor_persons']||0))||0) * (Number(it.laborUnitRate ?? (it['labor_unit_rate']||0))||0);
          const laborTotal = gen + sk;
          const laborParts = [];
          if (gen > 0) laborParts.push(`${Number(it.laborPersonsGeneral)}ëª… Ã— ${Number(it.laborUnitRateGeneral).toLocaleString()}ì›`);
          if (sk > 0) laborParts.push(`${Number(it.laborPersons)}ëª… Ã— ${Number(it.laborUnitRate).toLocaleString()}ì›`);
          const laborHTML = laborTotal > 0
            ? `<div class="text-xs text-blue-600 mt-1"><span class="font-medium">ì¸ë¶€ì„:</span> ${laborParts.join(', ')} = ${laborTotal.toLocaleString()}ì›</div>`
            : '';

          tr.innerHTML = `
            <td class="border px-2 py-2 text-center">${idx+1}</td>
            <td class="border px-2 py-2 text-center">${it.date||''}</td>
            <td class="border px-2 py-2">
              <div class="font-medium text-slate-900">${it.name||''}</div>
              ${(() => {
                const desc = (it.description ?? it.desc ?? '') || '';
                return desc ? `<div class='text-xs text-slate-600 whitespace-pre-line leading-relaxed'>${desc}</div>` : '';
              })()}
              ${laborHTML}
            </td>
            <td class="border px-2 py-2 text-center">${qty}</td>
            <td class="border px-2 py-2 text-center">${it.unit||''}</td>
            <td class="border px-2 py-2 text-right">${up.toLocaleString()}ì›</td>
            <td class="border px-2 py-2 text-right font-semibold">${total.toLocaleString()}ì›</td>
            <td class="border px-2 py-2 text-xs">${it.notes||''}</td>`;
          tb.appendChild(tr);
        });

        const sum = (inv.workItems||[]).reduce((s,it)=> s + (it.total!=null? Number(it.total): (Number(it.quantity)||0)*(Number(it.unitPrice)||0)), 0);
        document.getElementById('grandTotal').textContent = fmt(sum || inv.amount || 0);
        document.title = 'ì²­êµ¬ì„œìƒì„¸_' + (inv.id||'');
      }
    </script>
  </body>
  </html>
